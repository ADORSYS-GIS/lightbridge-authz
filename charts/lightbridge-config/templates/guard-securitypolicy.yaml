apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: {{ include "common.names.fullname" $ }}
  namespace: {{ include "common.names.namespace" $ }}
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: {{ include "common.names.fullname" $ }}
  authz:
    rbac:
      allow:
        rules:
        {{- range $tierName, $_ := .Values.tiers }}
          {{- range $i, $model := $.Values.models }}
            {{- if eq (include "allowed" (dict "tier" $tierName "model" $model.name "context" $) ) "true" }}
          - when:
              - headers:
                  - name: {{ include "H.tier" $ }}
                    value: {{ $tierName }}
                  - name: {{ include "H.model" $ }}
                    value: {{ $model.name }}
            {{- if $.Values.headers.tenant }}
                  - name: {{ include "H.tenant" $ }}
                    present: true
            {{- end }}
                  - name: {{ include "H.user" $ }}
                    present: true
            {{- end }}
          {{- end }}
        {{- end }}
